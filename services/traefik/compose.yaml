networks:
  nexus:
    external: true
services:
  traefik:
    cap_add:
      - NET_BIND_SERVICE
    cap_drop:
      - ALL
    command:
      - --accesslog.format=json
      - --accesslog=true
      - --api.dashboard=true
      - --api.insecure=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/letsencrypt/acme.json
      - --entrypoints.golinks.address=:8091
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.forwardedHeaders.trustedIPs=192.168.1.3/32,172.52.0.0/16,10.0.0.0/8,100.64.0.0/10
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN:?DOMAIN not set}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN:?DOMAIN not set},*.nexus.${DOMAIN:?DOMAIN not set}
      - --entrypoints.websecure.http.tls=true
      - --log.level=INFO
      - --ping=true
      - --providers.docker.defaultRule=Host(`{{ index .Labels "com.docker.compose.service" }}.${DOMAIN:?DOMAIN not set}`) || Host(`{{ index .Labels "com.docker.compose.service" }}.nexus.${DOMAIN:?DOMAIN not set}`)
      - --providers.docker.exposedbydefault=true
      - --providers.docker=true
      - --providers.file.filename=/etc/traefik/dynamic.yaml
      - --providers.file.watch=true
      - --serverstransport.insecureskipverify=true
    container_name: traefik
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    environment:
      CLOUDFLARE_DNS_API_TOKEN: ${CLOUDFLARE_API_TOKEN:?CLOUDFLARE_API_TOKEN not set}
      CLOUDFLARE_EMAIL: ${CLOUDFLARE_EMAIL:?CLOUDFLARE_EMAIL not set}
      DOMAIN: ${DOMAIN:?DOMAIN not set}
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: ${CLOUDFLARE_EMAIL:?CLOUDFLARE_EMAIL not set}
    extra_hosts:
      - host.docker.internal:host-gateway
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD", "traefik", "healthcheck", "--ping" ]
      timeout: 10s
    hostname: traefik
    image: traefik
    labels:
      homepage.description: Reverse proxy for exposing apps via HTTPS
      homepage.group: Gateway
      homepage.href: https://traefik.nexus.${DOMAIN:?DOMAIN not set}
      homepage.icon: traefik
      homepage.name: Traefik
      homepage.widget.type: traefik
      homepage.widget.url: http://traefik:8080
      traefik.http.services.traefik.loadbalancer.server.port: 8080
    networks:
      - nexus
    ports:
      - 443:443
      - 8080:8080
      - 8091:8091
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    volumes:
      - ./data/letsencrypt:/etc/letsencrypt
      - ./data:/etc/traefik:ro
      - ./data/plugins-storage:/plugins-storage
      - /var/run/docker.sock:/var/run/docker.sock:ro
