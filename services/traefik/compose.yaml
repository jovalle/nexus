services:
  traefik:
    image: traefik
    container_name: traefik
    hostname: traefik
    command:
      - --accesslog.format=json
      - --accesslog=true
      - --api.dashboard=true
      - --api.insecure=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/letsencrypt/acme.json
      - --entrypoints.golinks.address=:8090
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.forwardedHeaders.trustedIPs=192.168.1.3/32,172.52.0.0/16,10.0.0.0/8,100.64.0.0/10
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains[0].main=${DOMAIN}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN},*.nexus.${DOMAIN}
      - --entrypoints.websecure.http.tls=true
      - --log.level=INFO
      - --ping=true
      - --providers.docker.defaultRule=Host(`{{ index .Labels "com.docker.compose.service" }}.${DOMAIN}`) || Host(`{{ index .Labels "com.docker.compose.service" }}.nexus.${DOMAIN}`)
      - --providers.docker.exposedbydefault=true
      - --providers.docker=true
      - --providers.file.filename=/etc/traefik/dynamic.yaml
      - --providers.file.watch=true
      - --serverstransport.insecureskipverify=true
    environment:
      CLOUDFLARE_DNS_API_TOKEN: ${CLOUDFLARE_API_TOKEN:?no cloudflare api token provided}
      CLOUDFLARE_EMAIL: ${CLOUDFLARE_EMAIL:?no cloudflare email provided}
      DOMAIN: ${DOMAIN:?no domain provided}
      TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL: ${CLOUDFLARE_EMAIL:?no cloudflare email provided}
    extra_hosts:
      - host.docker.internal:host-gateway
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      homepage.group: Gateway
      homepage.name: Traefik
      homepage.icon: traefik
      homepage.description: Reverse proxy for exposing apps via HTTPS
      homepage.href: https://traefik.nexus.${DOMAIN}
      homepage.widget.type: traefik
      homepage.widget.url: http://traefik:8080
      traefik.enable: false
    ports:
      - 80:80
      - 443:443
      - 8080:8080
    read_only: true
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    volumes:
      - ${DATA_PATH}/letsencrypt:/etc/letsencrypt
      - ${DATA_PATH}/traefik:/etc/traefik:ro
      - ${DATA_PATH}/traefik/plugins-storage:/plugins-storage
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nexus

networks:
  nexus:
    external: true
