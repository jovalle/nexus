services:
  immich:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich
    hostname: immich
    depends_on:
      - postgres
      - redis
    command: ["start.sh", "immich"]
    environment:
      DB_HOSTNAME: ${IMMICH_DB_HOSTNAME:-postgres}
      DB_USERNAME: ${IMMICH_DB_USER:-immich}
      DB_PASSWORD: ${IMMICH_DB_PASSWORD:-}
      DB_DATABASE_NAME: ${IMMICH_DB_NAME:-immich}
      REDIS_HOSTNAME: redis
      UPLOAD_LOCATION: /usr/src/app/upload
      IMMICH_MACHINE_LEARNING_URL: http://immich-ml:3003
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:2283/api/server/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      homepage.group: Documents
      homepage.name: Immich
      homepage.icon: immich
      homepage.description: Photo and Video Management
      homepage.href: https://immich.${DOMAIN}
      homepage.widget.type: immich
      homepage.widget.url: http://immich-server:2283
      homepage.widget.key: ${IMMICH_API_KEY:-}
      traefik.http.services.immich-server.loadbalancer.server.port: 2283
    ports:
      - 2283:2283
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m
    volumes:
      - ${DATA_PATH}/immich/upload:/usr/src/app/upload
      - ${MEDIA_PATH}/photos:/usr/src/app/external:ro
    networks:
      - nexus

  immich-ml:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    hostname: immich-ml
    environment:
      DB_HOSTNAME: ${IMMICH_DB_HOSTNAME:-postgres}
      DB_USERNAME: ${IMMICH_DB_USER:-immich}
      DB_PASSWORD: ${IMMICH_DB_PASSWORD:-}
      DB_DATABASE_NAME: ${IMMICH_DB_NAME:-immich}
      REDIS_HOSTNAME: redis
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:3003/ping\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      traefik.enable: "false"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=512m
    volumes:
      - ${DATA_PATH}/immich/model-cache:/cache
    networks:
      - nexus

networks:
  nexus:
    external: true
