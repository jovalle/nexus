networks:
  nexus:
    external: true
services:
  authelia:
    cap_drop:
      - ALL
    container_name: authelia
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    environment:
      AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_SECRET:?AUTHELIA_SESSION_SECRET not set}
      AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_STORAGE_ENCRYPTION_KEY:?AUTHELIA_STORAGE_ENCRYPTION_KEY not set}
      DOMAIN: ${DOMAIN:?DOMAIN not set}
      DOMAIN_WATCHDOG_SECRET: ${DOMAIN_WATCHDOG_SECRET:?DOMAIN_WATCHDOG_SECRET not set}
      IMMICH_CLIENT_SECRET_HASH: ${IMMICH_CLIENT_SECRET_HASH:?IMMICH_CLIENT_SECRET_HASH not set}
      JWT_SECRET: ${AUTHELIA_JWT_SECRET:?AUTHELIA_JWT_SECRET not set}
      TZ: ${TZ:?TZ not set}
      X_AUTHELIA_CONFIG_FILTERS: template
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 30s
      test: [ "CMD", "wget", "-q", "-O-", "http://localhost:9091/api/health" ]
      timeout: 10s
    hostname: authelia
    image: authelia/authelia:4.38
    labels:
      homepage.description: Authentication & OIDC Provider
      homepage.group: Gateway
      homepage.href: https://auth.${DOMAIN:?DOMAIN not set}
      homepage.icon: authelia
      homepage.name: Authelia
      # Authelia ForwardAuth middleware with basic auth enabled
      traefik.http.middlewares.authelia-basic.forwardAuth.address: http://authelia:9091/api/authz/forward-auth?authelia_url=https://auth.${DOMAIN:?DOMAIN not set}
      traefik.http.middlewares.authelia-basic.forwardAuth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Email,Remote-Name
      traefik.http.middlewares.authelia-basic.forwardAuth.trustForwardHeader: true
      # Authelia ForwardAuth middleware for protecting other services
      traefik.http.middlewares.authelia.forwardAuth.address: http://authelia:9091/api/authz/forward-auth
      traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders: Remote-User,Remote-Groups,Remote-Email,Remote-Name
      traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader: true
      traefik.http.routers.authelia.entrypoints: websecure
      # Main Authelia portal
      traefik.http.routers.authelia.rule: Host(`auth.${DOMAIN:?DOMAIN not set}`)
      traefik.http.services.authelia.loadbalancer.server.port: 9091
    networks:
      - nexus
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    user: "${PUID:?PUID not set}:${PGID:?PGID not set}"
    volumes:
      - ./data:/config
