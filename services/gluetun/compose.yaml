services:
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    hostname: gluetun
    environment:
      PUID: ${PUID:?PUID not set}
      PGID: ${PGID:?PGID not set}
      TZ: ${TZ:?TZ not set}
      FIREWALL_INPUT_PORTS: 10095
      GLUETUN_API_KEY: ${GLUETUN_API_KEY:?GLUETUN_API_KEY not set}
      HTTPPROXY_STEALTH: "false"
      HTTP_CONTROL_SERVER_LOG: "false"
      PUBLICIP_FILE: /gluetun/ip
      VPN_SERVICE_PROVIDER: custom
      VPN_TYPE: wireguard
      WIREGUARD_ADDRESSES: ${WIREGUARD_ADDRESSES:?WIREGUARD_ADDRESSES not set}
      WIREGUARD_ENDPOINT_IP: ${WIREGUARD_ENDPOINT_IP:?WIREGUARD_ENDPOINT_IP not set}
      WIREGUARD_ENDPOINT_PORT: ${WIREGUARD_ENDPOINT_PORT:?WIREGUARD_ENDPOINT_PORT not set}
      WIREGUARD_PRIVATE_KEY: ${WIREGUARD_PRIVATE_KEY:?WIREGUARD_PRIVATE_KEY not set}
      WIREGUARD_PUBLIC_KEY: ${WIREGUARD_PUBLIC_KEY:?WIREGUARD_PUBLIC_KEY not set}
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -q -O /dev/null --header=\"X-API-Key: $${GLUETUN_API_KEY}\" http://127.0.0.1:8000/v1/publicip/ip"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    labels:
      homepage.group: Gateway
      homepage.name: Gluetun
      homepage.icon: gluetun
      homepage.description: VPN client for containers
      homepage.widget.type: gluetun
      homepage.widget.url: http://gluetun:8000
      homepage.widget.key: ${GLUETUN_API_KEY:?GLUETUN_API_KEY not set}
      homepage.widget.fields: '["public_ip", "region", "country"]'
      traefik.enable: false
    ports:
      - 6881:6881
      - 6881:6881/udp
      - 10095:10095
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    cap_drop:
      - ALL
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./data:/gluetun
    networks:
      - nexus
networks:
  nexus:
    external: true
