#!/usr/bin/env bash

# Nexus CLI - Main management tool for the nexus repository
# Manages Docker stacks, configurations, and development environment

set -euo pipefail

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Directories
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
STACKS_DIR="${ROOT_DIR}/stacks"
SCRIPTS_DIR="${ROOT_DIR}/scripts"

# Get available stacks
get_stacks() {
    find "${STACKS_DIR}" -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | sort
}

# Print colored message
print_info() {
    echo -e "${BLUE}$1${NC}"
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check prerequisites
check_prerequisites() {
    local missing=()
    local install_attempt="${1:-false}"

    print_info "Checking prerequisites..."

    # Check for direnv
    if ! command_exists direnv; then
        if [[ "$install_attempt" == "true" ]]; then
            print_warning "direnv not found. Attempting to install..."
            if command_exists brew; then
                brew install direnv
            elif command_exists apt-get; then
                sudo apt-get update && sudo apt-get install -y direnv
            else
                missing+=("direnv")
            fi
        else
            missing+=("direnv")
        fi
    fi

    # Check for docker
    if ! command_exists docker; then
        missing+=("docker")
    fi

    # Check for docker compose (v2 plugin or standalone)
    if ! docker compose version >/dev/null 2>&1 && ! command_exists docker-compose; then
        missing+=("docker-compose")
    fi

    # Check for git
    if ! command_exists git; then
        missing+=("git")
    fi

    # Check for python3 (needed for fmt command)
    if ! command_exists python3; then
        missing+=("python3")
    fi

    if [ ${#missing[@]} -eq 0 ]; then
        print_success "✓ All prerequisites are installed"

        # Check if direnv is hooked
        if command_exists direnv; then
            if ! grep -q "direnv hook" ~/.zshrc 2>/dev/null && ! grep -q "direnv hook" ~/.bashrc 2>/dev/null; then
                print_warning "⚠ direnv is installed but not hooked into your shell"
                echo ""
                echo "Add this to your ~/.zshrc or ~/.bashrc:"
                echo "  eval \"\$(direnv hook zsh)\"  # for zsh"
                echo "  eval \"\$(direnv hook bash)\" # for bash"
                echo ""
                echo "Then run: direnv allow ."
            fi
        fi

        return 0
    else
        print_error "✗ Missing prerequisites:"
        for dep in "${missing[@]}"; do
            echo "  - $dep"
        done

        if [[ "$install_attempt" == "false" ]]; then
            echo ""
            echo "Run 'nx check --install' to attempt automatic installation"
        fi

        return 1
    fi
}

# Setup function
setup() {
    print_info "Running Nexus setup..."

    if [ ! -f "${SCRIPTS_DIR}/setup.sh" ]; then
        print_error "Error: setup.sh not found"
        exit 1
    fi

    bash "${SCRIPTS_DIR}/setup.sh"
}

# Check environment files
check_env() {
    print_info "Checking environment files..."

    local errors=0

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "Checking ${stack}..."
            if ! (cd "${STACKS_DIR}/${stack}" && docker compose config > /dev/null 2>&1); then
                print_error "Error in ${stack}"
                ((errors++))
            fi
        fi
    done < <(get_stacks)

    if [ -f "${ROOT_DIR}/compose.yaml" ]; then
        echo "Checking root..."
        if ! (cd "${ROOT_DIR}" && docker compose config > /dev/null 2>&1); then
            print_error "Error in root"
            ((errors++))
        fi
    fi

    if [ $errors -eq 0 ]; then
        print_success "All environment files are valid"
    else
        print_error "Found $errors error(s)"
        return 1
    fi
}

# List all stacks
list_stacks() {
    print_info "Available stacks:"
    while IFS= read -r stack; do
        echo "  - ${stack}"
    done < <(get_stacks)
}

# Start stacks
start_stacks() {
    local stack="${1:-}"

    if [ -n "$stack" ]; then
        print_info "Starting ${stack} stack..."
        if [ "$stack" = "root" ]; then
            cd "${ROOT_DIR}" && docker compose up -d
        else
            if [ -d "${STACKS_DIR}/${stack}" ]; then
                cd "${STACKS_DIR}/${stack}" && docker compose up -d
            else
                print_error "Stack '${stack}' not found"
                return 1
            fi
        fi
    else
        print_info "Starting all stacks..."

        if [ -f "${ROOT_DIR}/compose.yaml" ]; then
            cd "${ROOT_DIR}" && docker compose up -d
        fi

        while IFS= read -r stack; do
            if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
                echo "Starting ${stack}..."
                cd "${STACKS_DIR}/${stack}" && docker compose up -d
            fi
        done < <(get_stacks)
    fi

    print_success "Started successfully"
}

# Stop stacks
stop_stacks() {
    local stack="${1:-}"

    if [ -n "$stack" ]; then
        print_info "Stopping ${stack} stack..."
        if [ "$stack" = "root" ]; then
            cd "${ROOT_DIR}" && docker compose down
        else
            if [ -d "${STACKS_DIR}/${stack}" ]; then
                cd "${STACKS_DIR}/${stack}" && docker compose down
            else
                print_error "Stack '${stack}' not found"
                return 1
            fi
        fi
    else
        print_info "Stopping all stacks..."

        while IFS= read -r stack; do
            if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
                echo "Stopping ${stack}..."
                cd "${STACKS_DIR}/${stack}" && docker compose down
            fi
        done < <(get_stacks)

        if [ -f "${ROOT_DIR}/compose.yaml" ]; then
            cd "${ROOT_DIR}" && docker compose down
        fi
    fi

    print_success "Stopped successfully"
}

# Restart stacks
restart_stacks() {
    local stack="${1:-}"

    if [ -n "$stack" ]; then
        print_info "Restarting ${stack} stack..."
        if [ "$stack" = "root" ]; then
            cd "${ROOT_DIR}" && docker compose restart
        else
            if [ -d "${STACKS_DIR}/${stack}" ]; then
                cd "${STACKS_DIR}/${stack}" && docker compose restart
            else
                print_error "Stack '${stack}' not found"
                return 1
            fi
        fi
    else
        print_info "Restarting all stacks..."

        if [ -f "${ROOT_DIR}/compose.yaml" ]; then
            cd "${ROOT_DIR}" && docker compose restart
        fi

        while IFS= read -r stack; do
            if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
                echo "Restarting ${stack}..."
                cd "${STACKS_DIR}/${stack}" && docker compose restart
            fi
        done < <(get_stacks)
    fi

    print_success "Restarted successfully"
}

# Show status
show_status() {
    print_info "Stack status:"

    if [ -f "${ROOT_DIR}/compose.yaml" ]; then
        echo "=== Root ==="
        cd "${ROOT_DIR}" && docker compose ps
    fi

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "=== ${stack} ==="
            cd "${STACKS_DIR}/${stack}" && docker compose ps
        fi
    done < <(get_stacks)
}

# Show logs
show_logs() {
    local stack="${1:-}"
    local tail="${2:-100}"
    local follow="${3:-false}"

    if [ -n "$stack" ]; then
        print_info "Showing logs for ${stack} stack..."
        if [ "$stack" = "root" ]; then
            if [ "$follow" = "true" ]; then
                cd "${ROOT_DIR}" && docker compose logs --tail "$tail" -f
            else
                cd "${ROOT_DIR}" && docker compose logs --tail "$tail"
            fi
        else
            if [ -d "${STACKS_DIR}/${stack}" ]; then
                if [ "$follow" = "true" ]; then
                    cd "${STACKS_DIR}/${stack}" && docker compose logs --tail "$tail" -f
                else
                    cd "${STACKS_DIR}/${stack}" && docker compose logs --tail "$tail"
                fi
            else
                print_error "Stack '${stack}' not found"
                return 1
            fi
        fi
    else
        print_info "Showing logs for all stacks..."

        if [ -f "${ROOT_DIR}/compose.yaml" ]; then
            cd "${ROOT_DIR}" && docker compose logs --tail "$tail"
        fi

        while IFS= read -r stack; do
            if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
                cd "${STACKS_DIR}/${stack}" && docker compose logs --tail "$tail"
            fi
        done < <(get_stacks)
    fi
}

# Pull images
pull_images() {
    print_info "Pulling latest images..."

    if [ -f "${ROOT_DIR}/compose.yaml" ]; then
        cd "${ROOT_DIR}" && docker compose pull
    fi

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "Pulling ${stack}..."
            cd "${STACKS_DIR}/${stack}" && docker compose pull
        fi
    done < <(get_stacks)

    print_success "Pull complete"
}

# Update containers
update_containers() {
    print_info "Updating all containers..."

    if [ -f "${ROOT_DIR}/compose.yaml" ]; then
        cd "${ROOT_DIR}" && docker compose pull && docker compose up -d
    fi

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "Updating ${stack}..."
            cd "${STACKS_DIR}/${stack}" && docker compose pull && docker compose up -d
        fi
    done < <(get_stacks)

    print_success "Update complete"
}

# Clean up Docker resources
clean_docker() {
    print_info "Cleaning up Docker resources..."
    docker system prune -f
    print_success "Cleanup complete"
}

# Format README
format_readme() {
    print_info "Updating README.md with service listings..."

    if [ ! -f "${SCRIPTS_DIR}/update-readme.py" ]; then
        print_error "Error: update-readme.py not found"
        return 1
    fi

    # Use venv python if available, otherwise fall back to python3
    local python_cmd="python3"
    if [ -f "${ROOT_DIR}/.venv/bin/python" ]; then
        python_cmd="${ROOT_DIR}/.venv/bin/python"
    fi

    "$python_cmd" "${SCRIPTS_DIR}/update-readme.py"
    print_success "README.md updated successfully"
}

# Build custom images
build_images() {
    print_info "Building custom images..."

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "Checking ${stack} for buildable images..."
            cd "${STACKS_DIR}/${stack}" && docker compose build 2>/dev/null || true
        fi
    done < <(get_stacks)

    print_success "Build complete"
}

# Create backup
create_backup() {
    print_info "Creating backup..."

    mkdir -p "${ROOT_DIR}/backups"
    local backup_file="backups/nexus-backup-$(date +%Y%m%d-%H%M%S).tar.gz"

    cd "${ROOT_DIR}"
    tar -czf "$backup_file" \
        --exclude='backups' \
        --exclude='.git' \
        --exclude='*/data' \
        stacks/ compose.yaml .env 2>/dev/null || true

    print_success "Backup created: ${backup_file}"
}

# Validate compose files
validate_compose() {
    print_info "Validating compose files..."

    local errors=0

    while IFS= read -r stack; do
        if [ -f "${STACKS_DIR}/${stack}/compose.yaml" ]; then
            echo "Validating ${stack}..."
            if ! docker compose -f "${STACKS_DIR}/${stack}/compose.yaml" config > /dev/null 2>&1; then
                print_error "Validation failed for ${stack}"
                ((errors++))
            fi
        fi
    done < <(get_stacks)

    if [ $errors -eq 0 ]; then
        print_success "All compose files are valid"
    else
        print_error "Validation failed for $errors stack(s)"
        return 1
    fi
}

# Show help
show_help() {
    cat << 'EOF'
Nexus CLI - Docker Stack Management Tool

Usage: nx <command> [options]

COMMANDS:
EOF

    # Dynamically generate command list from annotations
    echo "  Setup & Configuration:"
    grep -E "^\s+# @completion (check|setup|check-env|list) " "$0" | while IFS= read -r line; do
        if [[ $line =~ @completion\ ([a-z-]+)\ (.+)$ ]]; then
            printf "    %-20s %s\n" "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
        fi
    done

    echo ""
    echo "  Stack Management:"
    grep -E "^\s+# @completion (start|stop|restart|status|logs) " "$0" | while IFS= read -r line; do
        if [[ $line =~ @completion\ ([a-z-]+)\ (.+)$ ]]; then
            printf "    %-20s %s\n" "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
        fi
    done

    echo ""
    echo "  Maintenance:"
    grep -E "^\s+# @completion (pull|update|clean|fmt|build|backup|validate) " "$0" | while IFS= read -r line; do
        if [[ $line =~ @completion\ ([a-z-]+)\ (.+)$ ]]; then
            printf "    %-20s %s\n" "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
        fi
    done

    echo ""
    echo "  General:"
    grep -E "^\s+# @completion (help|version) " "$0" | while IFS= read -r line; do
        if [[ $line =~ @completion\ ([a-z-]+)\ (.+)$ ]]; then
            printf "    %-20s %s\n" "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
        fi
    done

    cat << 'EOF'

OPTIONS:
  --install           (with check) Attempt to install missing prerequisites
  -f, --follow        (with logs) Follow log output

EXAMPLES:
  nx check              # Check if all prerequisites are installed
  nx check --install    # Check and install missing prerequisites
  nx start              # Start all stacks
  nx start media        # Start only the media stack
  nx stop core          # Stop the core stack
  nx logs app -f        # Follow logs for app stack
  nx status             # Show status of all stacks
  nx update             # Update all containers
  nx fmt                # Update README

ENVIRONMENT:
  Use direnv to automatically load .envrc which adds .bin to PATH
  Run 'direnv allow .' after cloning the repository

For more information, visit: https://github.com/jovalle/nexus
EOF
}

# Show version
show_version() {
    echo "Nexus CLI v1.0.0"
    echo "Repository: https://github.com/jovalle/nexus"
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        # @completion check Check prerequisites (optionally install missing ones)
        # @arg --install Attempt to install missing prerequisites
        check)
            if [[ "${1:-}" == "--install" ]]; then
                check_prerequisites "true"
            else
                check_prerequisites "false"
            fi
            ;;
        # @completion setup Run initial setup (install brew, make, etc.)
        setup)
            setup
            ;;
        # @completion check-env Verify environment variables in all stacks
        check-env)
            check_env
            ;;
        # @completion list List all available stacks
        list)
            list_stacks
            ;;
        # @completion start Start all stacks or a specific stack
        # @arg [stack] Stack name to start
        start)
            start_stacks "${1:-}"
            ;;
        # @completion stop Stop all stacks or a specific stack
        # @arg [stack] Stack name to stop
        stop)
            stop_stacks "${1:-}"
            ;;
        # @completion restart Restart all stacks or a specific stack
        # @arg [stack] Stack name to restart
        restart)
            restart_stacks "${1:-}"
            ;;
        # @completion status Show status of all stacks
        status)
            show_status
            ;;
        # @completion logs Show logs (optionally follow with -f)
        # @arg [stack] Stack name to show logs for
        # @arg -f,--follow Follow log output
        logs)
            local stack="${1:-}"
            local follow="false"
            if [[ "${2:-}" == "-f" || "${2:-}" == "--follow" ]]; then
                follow="true"
            fi
            show_logs "$stack" "100" "$follow"
            ;;
        # @completion pull Pull latest images for all stacks
        pull)
            pull_images
            ;;
        # @completion update Update all containers to latest versions
        update)
            update_containers
            ;;
        # @completion clean Remove stopped containers and unused images
        clean)
            clean_docker
            ;;
        # @completion fmt Update README.md with latest service listings
        fmt)
            format_readme
            ;;
        # @completion build Build custom images (if any)
        build)
            build_images
            ;;
        # @completion backup Create backup of all stack configurations
        backup)
            create_backup
            ;;
        # @completion validate Validate all compose files
        validate)
            validate_compose
            ;;
        # @completion help Show this help message
        help|--help|-h)
            show_help
            ;;
        # @completion version Show version information
        version|--version|-v)
            show_version
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            echo "Run 'nx help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
